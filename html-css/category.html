<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh mục sản phẩm - Sona</title>
    <link rel="icon" type="image/png" href="/img/LEGO web.png">
    <link rel="stylesheet" href="/html-css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="menu-wrapper">
                        <button class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="sidebar-category" id="sidebar">
                            <div class="sidebar-header">
                                <i class="fas fa-bars"></i>
                                <span>DANH MỤC SẢN PHẨM</span>
                            </div>
                            <ul class="category-list">
                                <li><a href="category.html?cat=vga"><i class="fas fa-microchip"></i> VGA - Card đồ họa</a></li>
                                <li><a href="category.html?cat=cpu"><i class="fas fa-memory"></i> CPU - Bộ vi xử lý</a></li>
                                <li><a href="category.html?cat=ram"><i class="fas fa-memory"></i> RAM - Bộ nhớ</a></li>
                                <li><a href="category.html?cat=ssd"><i class="fas fa-hdd"></i> SSD - Ổ cứng</a></li>
                                <li><a href="category.html?cat=hdd"><i class="fas fa-database"></i> HDD - Ổ cứng</a></li>
                                <li><a href="category.html?cat=mainboard"><i class="fas fa-th"></i> Mainboard</a></li>
                                <li><a href="category.html?cat=psu"><i class="fas fa-plug"></i> Nguồn máy tính</a></li>
                                <li><a href="category.html?cat=case"><i class="fas fa-desktop"></i> Case máy tính</a></li>
                                <li><a href="category.html?cat=cooling"><i class="fas fa-fan"></i> Tản nhiệt</a></li>
                                <li><a href="category.html?cat=monitor"><i class="fas fa-tv"></i> Màn hình</a></li>
                                <li><a href="category.html?cat=keyboard"><i class="fas fa-keyboard"></i> Bàn phím</a></li>
                                <li><a href="category.html?cat=mouse"><i class="fas fa-mouse"></i> Chuột</a></li>
                                <li><a href="category.html?cat=headset"><i class="fas fa-headphones"></i> Tai nghe</a></li>
                                <li><a href="category.html?cat=accessories"><i class="fas fa-puzzle-piece"></i> Phụ kiện khác</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="logo">
                        <a href="index.html">
                            <img src="../img/sona-logo.png" alt="Sona Logo">
                        </a>
                    </div>
                </div>
                <div class="header-icons">
                    <i class="fas fa-search" id="searchIcon"></i>
                    <a href="cart.html" class="cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">0</span>
                    </a>
                    <div class="user-menu-wrapper">
                        <button id="userIcon" class="user-button">
                            <i class="fas fa-user"></i>
                            <span id="userName" class="user-name"></span>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <a href="account.html" class="dropdown-item">
                                <i class="fas fa-user-circle"></i> Tài khoản
                            </a>
                            <a href="#" class="dropdown-item" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Đăng xuất
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1 class="page-title" id="categoryTitle">Danh mục sản phẩm</h1>
            
            <div class="category-layout">
                <!-- Sidebar Filters -->
                <aside class="filter-sidebar">
                    <button class="filter-toggle" id="filterToggle">
                        <i class="fas fa-bars"></i> Bộ lọc tìm kiếm
                    </button>
                    
                    <div class="filter-content" id="filterContent">
                        <!-- Hãng sản xuất -->
                        <div class="filter-section">
                            <h3 class="filter-title">Hãng sản xuất <i class="fas fa-chevron-down"></i></h3>
                            <div class="filter-options" style="display: block;">
                                <!-- Brands will be dynamically loaded by JavaScript -->
                            </div>
                        </div>

                        <!-- Mức giá -->
                        <div class="filter-section collapsed">
                            <h3 class="filter-title">Mức giá <i class="fas fa-chevron-down"></i></h3>
                            <div class="filter-options" style="display: none;">
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="all" checked>
                                    <span>Tất cả</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="0-5">
                                    <span>Dưới 5 triệu</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="5-10">
                                    <span>Từ 5 - 10 triệu</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="10-15">
                                    <span>Từ 10 - 15 triệu</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="15-20">
                                    <span>Từ 15 - 20 triệu</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="20-25">
                                    <span>Từ 20 - 25 triệu</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="25-30">
                                    <span>Từ 25 - 30 triệu</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="price" value="30+">
                                    <span>Trên 30 triệu</span>
                                </label>
                            </div>
                            
                            <div class="price-range-input" style="display: none;">
                                <p>Hoặc nhập khoảng giá phù hợp với bạn:</p>
                                <div class="price-inputs">
                                    <input type="text" id="minPrice" placeholder="16.990.000₫" value="16.990.000">
                                    <span>~</span>
                                    <input type="text" id="maxPrice" placeholder="139.390.000₫" value="139.390.000">
                                </div>
                                <input type="range" class="price-slider" min="0" max="150000000" step="1000000">
                            </div>
                        </div>

                        <!-- Tình trạng -->
                        <div class="filter-section collapsed">
                            <h3 class="filter-title">Tình trạng <i class="fas fa-chevron-down"></i></h3>
                            <div class="filter-options" style="display: none;">
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="status" value="available">
                                    <span class="checkmark"></span>
                                    <span>Còn hàng</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" name="status" value="out-of-stock">
                                    <span class="checkmark"></span>
                                    <span>Hết hàng</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Product Content -->
                <div class="product-content">
                    <div class="sort-bar">
                        <span class="result-count">Hiển thị 1-12 trong 48 sản phẩm</span>
                        <select class="sort-select">
                            <option>Mới nhất</option>
                            <option>Giá tăng dần</option>
                            <option>Giá giảm dần</option>
                            <option>Bán chạy nhất</option>
                        </select>
                    </div>

                    <section class="product-grid" id="productList">
                        <!-- Các sản phẩm sẽ được load động bằng JavaScript -->
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-close" id="searchClose">
            <i class="fas fa-times"></i>
        </div>
        <div class="search-box">
            <input type="text" placeholder="Tìm kiếm sản phẩm..." id="searchInput">
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Sona - Máy tính và Phụ kiện công nghệ</p>
            <div class="zalo-icon">
                <i class="fab fa-facebook-messenger"></i> Zalo
            </div>
        </div>
    </footer>

    <script src="/html-css/script.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        
        // Category mapping
        const categoryMap = {
            'vga': 'DM_VGA',
            'cpu': 'DM_CPU',
            'ram': 'DM_RAM',
            'ssd': 'DM_SSD',
            'hdd': 'DM_HDD',
            'mainboard': 'DM_Mainboard',
            'psu': 'DM_PSU',
            'case': 'DM_Case',
            'cooling': 'DM_Cooling',
            'monitor': 'DM_Monitor',
            'keyboard': 'DM_Keyboard',
            'mouse': 'DM_Mouse',
            'headset': 'DM_Headset',
            'accessories': 'DM_Accessories'
        };

        const categoryNames = {
            'vga': 'VGA - Card đồ họa',
            'cpu': 'CPU - Bộ vi xử lý',
            'ram': 'RAM - Bộ nhớ',
            'ssd': 'SSD - Ổ cứng',
            'hdd': 'HDD - Ổ cứng',
            'mainboard': 'Mainboard',
            'psu': 'Nguồn máy tính',
            'case': 'Case máy tính',
            'cooling': 'Tản nhiệt',
            'monitor': 'Màn hình',
            'keyboard': 'Bàn phím',
            'mouse': 'Chuột',
            'headset': 'Tai nghe',
            'accessories': 'Phụ kiện khác'
        };

        // Get category from URL
        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('cat') || 'vga';
        const categoryId = categoryMap[categoryParam];
        const categoryName = categoryNames[categoryParam];

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(price);
        }

        // Calculate discount
        function calculateDiscount(price) {
            const discount = Math.floor(Math.random() * 16) + 5;
            const oldPrice = price / (1 - discount / 100);
            return {
                oldPrice: Math.round(oldPrice),
                discount: discount
            };
        }

        // Render product card
        function renderProductCard(product) {
            const { oldPrice, discount } = calculateDiscount(product.GiaBan);
            let imagePath = product.HinhAnhChinh;
            if (imagePath.startsWith('../')) {
                imagePath = imagePath.substring(3);
            }
            if (!imagePath.startsWith('/')) {
                imagePath = '/' + imagePath;
            }
            return `
                <div class="product-card">
                    <a href="/html-css/product.html?id=${product.ID_SP}">
                        <img src="${imagePath}" alt="${product.TenSP}" onerror="this.src='https://via.placeholder.com/250x200/ddd/999?text=No+Image'">
                        <h3>${product.TenSP}</h3>
                        <div class="price">
                            <span class="current-price">${formatPrice(product.GiaBan)}</span>
                            <span class="old-price">${formatPrice(oldPrice)}</span>
                            <span class="discount">-${discount}%</span>
                        </div>
                    </a>
                </div>
            `;
        }

        // Load products by category
        async function loadCategoryProducts() {
            try {
                const response = await fetch(`${API_URL}/products/category/${categoryId}`);
                allProducts = await response.json();
                
                const productList = document.getElementById('productList');
                const categoryTitle = document.getElementById('categoryTitle');
                const resultCount = document.querySelector('.result-count');
                
                // Update title
                categoryTitle.textContent = categoryName;
                
                if (allProducts.length > 0) {
                    productList.innerHTML = allProducts.map(renderProductCard).join('');
                    resultCount.textContent = `Hiển thị 1-${Math.min(12, allProducts.length)} trong ${allProducts.length} sản phẩm`;
                } else {
                    productList.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Không có sản phẩm trong danh mục này.</p>';
                    resultCount.textContent = 'Hiển thị 0 sản phẩm';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productList').innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Không thể tải sản phẩm. Vui lòng thử lại sau.</p>';
            }
        }

        // Store all products for filtering
        let allProducts = [];

        // Load brands for filter
        async function loadBrands() {
            try {
                const response = await fetch(`${API_URL}/products/category/${categoryId}`);
                allProducts = await response.json();
                
                console.log('All products loaded:', allProducts); // Debug
                
                // Extract unique brands from products in this category
                const brands = [...new Set(allProducts.map(p => p.TenHang).filter(Boolean))].sort();
                
                console.log('Brands found:', brands); // Debug
                
                const brandFilterSection = document.querySelector('.filter-section:first-child .filter-options');
                if (brands.length > 0) {
                    brandFilterSection.innerHTML = `
                        <label class="filter-checkbox">
                            <input type="checkbox" name="brand" value="all" checked>
                            <span>Tất cả</span>
                        </label>
                        ${brands.map(brand => `
                            <label class="filter-checkbox">
                                <input type="checkbox" name="brand" value="${brand}">
                                <span>${brand}</span>
                            </label>
                        `).join('')}
                    `;
                    
                    // Add event listeners after creating checkboxes
                    brandFilterSection.querySelectorAll('input[name="brand"]').forEach(cb => {
                        cb.addEventListener('change', applyFilters);
                    });
                } else {
                    brandFilterSection.innerHTML = '<p style="padding: 10px; color: #999;">Không có hãng nào</p>';
                }
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        // Apply filters
        function applyFilters() {
            console.log('Apply filters called'); // Debug
            
            const allCheckbox = document.querySelector('input[name="brand"][value="all"]');
            const brandCheckboxes = document.querySelectorAll('input[name="brand"]:not([value="all"])');
            
            // Get selected brands
            const selectedBrands = [];
            let hasChecked = false;
            
            brandCheckboxes.forEach(cb => {
                if (cb.checked) {
                    selectedBrands.push(cb.value);
                    hasChecked = true;
                }
            });

            console.log('Selected brands:', selectedBrands); // Debug

            // Handle "Tất cả" checkbox
            if (allCheckbox) {
                if (allCheckbox.checked && hasChecked) {
                    // If user clicked a specific brand, uncheck "Tất cả"
                    allCheckbox.checked = false;
                } else if (!hasChecked) {
                    // If no brands selected, ensure "Tất cả" is checked
                    allCheckbox.checked = true;
                }
                
                // If "Tất cả" was just checked, uncheck all others
                if (allCheckbox.checked && event && event.target === allCheckbox) {
                    brandCheckboxes.forEach(cb => cb.checked = false);
                    selectedBrands.length = 0;
                }
            }

            // Filter products
            let filteredProducts = allProducts;
            
            // Filter by brand if specific brands are selected
            if (selectedBrands.length > 0) {
                filteredProducts = allProducts.filter(p => {
                    const match = selectedBrands.includes(p.TenHang);
                    console.log(`Product: ${p.TenSP}, Brand: ${p.TenHang}, Match: ${match}`); // Debug
                    return match;
                });
            }

            console.log('Filtered products count:', filteredProducts.length); // Debug

            // Render filtered products
            const productList = document.getElementById('productList');
            const resultCount = document.querySelector('.result-count');
            
            if (filteredProducts.length > 0) {
                productList.innerHTML = filteredProducts.map(renderProductCard).join('');
                resultCount.textContent = `Hiển thị 1-${Math.min(12, filteredProducts.length)} trong ${filteredProducts.length} sản phẩm`;
            } else {
                productList.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Không tìm thấy sản phẩm phù hợp với bộ lọc.</p>';
                resultCount.textContent = 'Hiển thị 0 sản phẩm';
            }
        }

        // Toggle filter sections
        function setupFilterToggles() {
            document.querySelectorAll('.filter-title').forEach(title => {
                title.addEventListener('click', function() {
                    const section = this.parentElement;
                    const options = section.querySelector('.filter-options, .price-range-input');
                    const isCollapsed = section.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        section.classList.remove('collapsed');
                        if (options) options.style.display = 'block';
                    } else {
                        section.classList.add('collapsed');
                        if (options) options.style.display = 'none';
                    }
                });
            });
        }

        // Load products on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCategoryProducts();
            await loadBrands();
            setupFilterToggles();
        });

        // Search overlay functionality
        const searchIcon = document.getElementById('searchIcon');
        const searchOverlay = document.getElementById('searchOverlay');
        const searchClose = document.getElementById('searchClose');
        const searchInput = document.getElementById('searchInput');

        if (searchIcon) {
            searchIcon.addEventListener('click', () => {
                searchOverlay.classList.add('active');
                setTimeout(() => searchInput.focus(), 300);
            });
        }

        if (searchClose) {
            searchClose.addEventListener('click', () => {
                searchOverlay.classList.remove('active');
            });
        }

        if (searchOverlay) {
            searchOverlay.addEventListener('click', (e) => {
                if (e.target === searchOverlay) {
                    searchOverlay.classList.remove('active');
                }
            });
        }

        // User authentication UI
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userIcon = document.getElementById('userIcon');
            const userName = document.getElementById('userName');
            const userDropdown = document.getElementById('userDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            if (token && user.hoTen) {
                // User is logged in
                userName.textContent = user.hoTen;
                userName.style.display = 'inline';
            } else {
                // User is not logged in
                userName.style.display = 'none';
                // Redirect to login when clicking user icon
                if (userIcon) {
                    userIcon.addEventListener('click', (e) => {
                        if (!token) {
                            e.stopPropagation();
                            window.location.href = 'login.html';
                        }
                    });
                }
            }

            // Toggle dropdown
            if (userIcon && token) {
                userIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.classList.toggle('active');
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (userDropdown && !userIcon.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });

            // Logout functionality
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    alert('Đã đăng xuất thành công!');
                    window.location.href = 'login.html';
                });
            }
        });
    </script>
</body>
</html>