<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thanh toán - Sona</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/img/LEGO web.png">
    <link rel="stylesheet" href="/html-css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f0f2f5;
        }
        .checkout-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            align-items: start;
        }
        .checkout-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .checkout-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .checkout-section h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #333;
            font-weight: 600;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
        }
        .form-group input,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #0066ff;
            outline: none;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .shipping-options {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }
        .shipping-option {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .shipping-option label {
            white-space: nowrap;
            margin: 0;
            line-height: 20px;
        }
        .shipping-option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #0066ff;
            flex-shrink: 0;
            margin: 0;
        }
        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .payment-method:hover {
            border-color: #0066ff;
        }
        .payment-method input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #9d6fcc;
            flex-shrink: 0;
            margin: 0;
        }
        .payment-method label {
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            margin: 0;
            line-height: 20px;
        }
        .products-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .products-section h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #333;
            font-weight: 600;
        }
        .product-table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }
        .product-table thead {
            background: #1a1a1a;
        }
        .product-table th {
            text-align: left;
            padding: 12px 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #fff;
            border: none;
        }
        .product-table td {
            padding: 15px 8px;
            vertical-align: middle;
            border: none;
        }
        .product-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
        }
        .product-table tbody tr:last-child {
            border-bottom: none;
        }
        .product-table img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background: #f8f8f8;
            border-radius: 6px;
        }
        .product-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
            margin-bottom: 4px;
        }
        .product-specs {
            font-size: 0.8rem;
            color: #666;
        }
        .checkout-summary {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 100px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            font-size: 1rem;
        }
        .summary-row.total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            padding-top: 16px;
            border-top: 2px solid #e0e0e0;
        }
        .summary-row.total .price {
            color: #0066ff;
        }
        .checkout-btn {
            width: 100%;
            background: #0066ff;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }
        .checkout-btn:hover {
            background: #0052cc;
        }
        @media (max-width: 992px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .checkout-summary {
                position: static;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="menu-wrapper">
                        <button class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="sidebar-category" id="sidebar">
                            <div class="sidebar-header">
                                <i class="fas fa-bars"></i>
                                <span>DANH MỤC SẢN PHẨM</span>
                            </div>
                            <ul class="category-list">
                                <li><a href="category.html?cat=vga"><i class="fas fa-microchip"></i> VGA - Card đồ họa</a></li>
                                <li><a href="category.html?cat=cpu"><i class="fas fa-memory"></i> CPU - Bộ vi xử lý</a></li>
                                <li><a href="category.html?cat=ram"><i class="fas fa-memory"></i> RAM - Bộ nhớ</a></li>
                                <li><a href="category.html?cat=ssd"><i class="fas fa-hdd"></i> SSD - Ổ cứng</a></li>
                                <li><a href="category.html?cat=hdd"><i class="fas fa-database"></i> HDD - Ổ cứng</a></li>
                                <li><a href="category.html?cat=mainboard"><i class="fas fa-th"></i> Mainboard</a></li>
                                <li><a href="category.html?cat=psu"><i class="fas fa-plug"></i> Nguồn máy tính</a></li>
                                <li><a href="category.html?cat=case"><i class="fas fa-desktop"></i> Case máy tính</a></li>
                                <li><a href="category.html?cat=cooling"><i class="fas fa-fan"></i> Tản nhiệt</a></li>
                                <li><a href="category.html?cat=monitor"><i class="fas fa-tv"></i> Màn hình</a></li>
                                <li><a href="category.html?cat=keyboard"><i class="fas fa-keyboard"></i> Bàn phím</a></li>
                                <li><a href="category.html?cat=mouse"><i class="fas fa-mouse"></i> Chuột</a></li>
                                <li><a href="category.html?cat=headset"><i class="fas fa-headphones"></i> Tai nghe</a></li>
                                <li><a href="category.html?cat=accessories"><i class="fas fa-puzzle-piece"></i> Phụ kiện khác</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="logo">
                        <a href="index.html">
                            <img src="../img/sona-logo.png" alt="Sona Logo">
                        </a>
                    </div>
                </div>
                <div class="header-icons">
                    <i class="fas fa-search"></i>
                    <a href="cart.html" class="cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">1</span>
                    </a>
                    <div class="user-menu-wrapper">
                        <button id="userIcon" class="user-button">
                            <i class="fas fa-user"></i>
                            <span id="userName" class="user-name"></span>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <a href="account.html" class="dropdown-item">
                                <i class="fas fa-user-circle"></i> Tài khoản
                            </a>
                            <a href="#" class="dropdown-item" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Đăng xuất
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Checkout Content -->
    <div class="checkout-container">
        <div class="checkout-main">
            <!-- Thông tin người nhận -->
            <div class="checkout-section">
                <h2>Thông tin người nhận</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Họ và tên:</label>
                        <input type="text" name="customerName" placeholder="Họ và tên" required>
                    </div>
                    <div class="form-group">
                        <label>Số điện thoại:</label>
                        <input type="tel" name="customerPhone" placeholder="Số điện thoại" required>
                    </div>
                </div>
            </div>

            <!-- Hình thức nhận hàng -->
            <div class="checkout-section">
                <h2>Hình thức nhận hàng</h2>
                <div class="shipping-options">
                    <div class="shipping-option">
                        <input type="radio" id="delivery" name="shipping" value="delivery" checked>
                        <label for="delivery">Giao tận nơi</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Địa chỉ:</label>
                        <input type="text" name="customerAddress" placeholder="Địa chỉ" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Ghi chú:</label>
                        <textarea name="note" placeholder="Ghi chú thêm về đơn hàng của bạn"></textarea>
                    </div>
                </div>
            </div>

            <!-- Thông tin thanh toán -->
            <div class="checkout-section">
                <h2>Thông tin thanh toán</h2>
                <div class="payment-method">
                    <input type="radio" id="bank-transfer" name="payment" value="bank-transfer" checked>
                    <label for="bank-transfer">Chuyển khoản qua ngân hàng</label>
                </div>
            </div>

            <!-- Sản phẩm trong đơn -->
            <div class="products-section">
                <h2 id="orderItemsTitle">Sản phẩm trong đơn (0)</h2>
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá bán</th>
                            <th>Số lượng</th>
                        </tr>
                    </thead>
                    <tbody id="orderItemsTbody">
                        <!-- Products will be loaded from cart -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary -->
        <div class="checkout-summary">
            <div class="summary-row">
                <span>Tổng phụ:</span>
                <span class="price">58,800,000₫</span>
            </div>
            <div class="summary-row total">
                <span>Tổng cộng:</span>
                <span class="price">58,800,000₫</span>
            </div>
            <button class="checkout-btn" onclick="confirmOrder()">Xác Nhận Đặt Hàng</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Sona - Máy tính và Phụ kiện công nghệ</p>
            <div class="zalo-icon">
                <i class="fab fa-facebook-messenger"></i> Zalo
            </div>
        </div>
    </footer>

    <script src="/html-css/script.js"></script>
    <script>
        // User authentication UI (show name like homepage)
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userIcon = document.getElementById('userIcon');
            const userName = document.getElementById('userName');
            const userDropdown = document.getElementById('userDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            if (token && user.hoTen) {
                userName.textContent = user.hoTen;
                userName.style.display = 'inline';
            } else {
                userName.style.display = 'none';
                if (userIcon) {
                    userIcon.addEventListener('click', (e) => {
                        if (!localStorage.getItem('token')) {
                            e.stopPropagation();
                            window.location.href = 'login.html';
                        }
                    });
                }
            }

            if (userIcon && token) {
                userIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.classList.toggle('active');
                });
            }
            document.addEventListener('click', (e) => {
                if (userDropdown && !userIcon.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    alert('Đã đăng xuất thành công!');
                    window.location.href = 'login.html';
                });
            }
        });

        // Cart helpers
        function getCart() {
            try { return JSON.parse(localStorage.getItem('cart') || '[]'); } catch { return []; }
        }
        function formatVND(n) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(Number(n||0)); }

        // Hydrate cart items with data from backend
        async function hydrateItem(item) {
            if (item && item.name && item.image && item.price) return item;
            try {
                let p = null;
                // Try fetch by ID
                const idRes = await fetch('http://localhost:3000/api/products/' + encodeURIComponent(item.id));
                if (idRes.ok) {
                    p = await idRes.json();
                } else {
                    // Fallback search
                    const searchRes = await fetch('http://localhost:3000/api/products/search?q=' + encodeURIComponent(item.id));
                    if (searchRes.ok) {
                        const list = await searchRes.json();
                        if (Array.isArray(list) && list.length) p = list[0];
                    }
                }
                if (p) {
                    let imgPath = p.HinhAnhChinh || '';
                    if (imgPath.startsWith('../')) imgPath = imgPath.substring(3);
                    if (imgPath && !imgPath.startsWith('/')) imgPath = '/' + imgPath;
                    item.name = p.TenSP || item.name;
                    item.price = Number(p.GiaBan || item.price || 0);
                    item.image = imgPath || item.image;
                    item.cpu = item.cpu || p.CPU || p.TenCPU || '';
                }
            } catch {}
            return item;
        }

        // Load and render order items
        async function loadOrderItems() {
            const tbody = document.getElementById('orderItemsTbody');
            const titleEl = document.getElementById('orderItemsTitle');
            const subtotalEl = document.querySelector('.checkout-summary .summary-row .price');
            const totalEl = document.querySelector('.checkout-summary .summary-row.total .price');
            
            let cart = getCart();

            // Empty state
            if (!cart.length) {
                tbody.innerHTML = `<tr><td colspan="4" style="padding:24px; text-align:center; color:#666;">Giỏ hàng trống. Hãy thêm sản phẩm trước khi thanh toán.</td></tr>`;
                titleEl.textContent = 'Sản phẩm trong đơn (0)';
                if (subtotalEl) subtotalEl.textContent = formatVND(0);
                if (totalEl) totalEl.textContent = formatVND(0);
                return;
            }

            // Hydrate all items
            const hydrated = await Promise.all(cart.map(hydrateItem));
            cart = hydrated;

            let subtotal = 0;
            tbody.innerHTML = cart.map((item, idx) => {
                const lineTotal = Number(item.price || 0) * Number(item.qty || 1);
                subtotal += lineTotal;
                const img = item.image || '/img/legion.png';
                const name = item.name || ('Sản phẩm #' + item.id);
                const specs = item.cpu ? `(CPU: ${item.cpu})` : '';
                return `
                <tr>
                    <td>
                        <img src="${img}" alt="${name}">
                    </td>
                    <td>
                        <div class="product-name">${name}</div>
                        <div class="product-specs">${specs}</div>
                    </td>
                    <td><strong>${formatVND(item.price || 0)}</strong></td>
                    <td>${item.qty || 1}</td>
                </tr>`;
            }).join('');

            titleEl.textContent = `Sản phẩm trong đơn (${cart.length})`;
            if (subtotalEl) subtotalEl.textContent = formatVND(subtotal);
            if (totalEl) totalEl.textContent = formatVND(subtotal);
        }

        async function confirmOrder() {
            const cart = getCart();
            if (!cart.length) {
                alert('Giỏ hàng trống! Vui lòng thêm sản phẩm trước khi đặt hàng.');
                return;
            }

            // Get customer info from form
            const fullName = document.querySelector('input[name="customerName"]')?.value || document.querySelector('input[placeholder="Họ và tên"]')?.value;
            const phone = document.querySelector('input[name="customerPhone"]')?.value || document.querySelector('input[placeholder="Số điện thoại"]')?.value;
            const address = document.querySelector('input[name="customerAddress"]')?.value || document.querySelector('input[placeholder="Địa chỉ"]')?.value;
            const note = document.querySelector('textarea[name="note"]')?.value || document.querySelector('textarea[placeholder*="Ghi chú"]')?.value;

            // Validate required fields
            if (!fullName || !phone || !address) {
                alert('Vui lòng điền đầy đủ thông tin họ tên, số điện thoại và địa chỉ!');
                return;
            }

            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token) {
                if (confirm('Bạn cần đăng nhập để đặt hàng. Chuyển đến trang đăng nhập?')) {
                    window.location.href = 'login.html';
                }
                return;
            }

            try {
                // Prepare order data
                const orderData = {
                    items: cart,
                    customerInfo: {
                        name: fullName,
                        phone: phone,
                        address: address
                    },
                    paymentMethod: 'bank_transfer',
                    note: note || ''
                };

                // Call API to create order
                const response = await fetch('http://localhost:3000/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });

                // Check if response is valid JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server trả về dữ liệu không hợp lệ');
                }

                const result = await response.json();

                if (response.status === 401 || response.status === 403) {
                    // Token expired or invalid
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại!');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.ok && result.success) {
                    alert('Đơn hàng của bạn đã được đặt thành công!\nMã đơn hàng: ' + result.orderId);
                    // Clear cart after successful order
                    localStorage.removeItem('cart');
                    // Redirect to account page to view orders
                    window.location.href = 'account.html';
                } else {
                    throw new Error(result.message || 'Không thể tạo đơn hàng');
                }
            } catch (error) {
                console.error('Error creating order:', error);
                
                if (error.message.includes('JSON')) {
                    alert('Lỗi kết nối với server. Vui lòng đăng nhập lại!');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                } else {
                    alert('Có lỗi xảy ra khi đặt hàng: ' + error.message + '\nVui lòng thử lại sau.');
                }
            }
        }

        // Load items on page load
        document.addEventListener('DOMContentLoaded', loadOrderItems);
    </script>
</body>
</html>
